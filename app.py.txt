import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
from fpdf import FPDF
import os
from datetime import date

# --- ‡§™‡•á‡§ú ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó ---
st.set_page_config(page_title="Secure Ledger App", layout="wide")

# ==========================================
# üîê 1. ‡§≤‡•â‡§ó‡§ø‡§® ‡§∏‡§ø‡§∏‡•ç‡§ü‡§Æ (LOGIN SYSTEM)
# ==========================================
if 'logged_in' not in st.session_state:
    st.session_state['logged_in'] = False

def check_login():
    st.title("üîí Login Required")
    st.markdown("Please enter your credentials to access the Ledger.")
    
    col1, col2 = st.columns([1, 2])
    with col1:
        username = st.text_input("Username")
        password = st.text_input("Password", type="password")
        
        if st.button("Login"):
            # --- ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°: admin / 12345 ---
            if username == "admin" and password == "12345":
                st.session_state['logged_in'] = True
                st.rerun()
            else:
                st.error("‚ùå Incorrect Username or Password")

# ==========================================
# üìä 2. ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§ê‡§™ (MAIN APP LOGIC)
# ==========================================
def main_app():
    # ‡§∏‡§æ‡§á‡§°‡§¨‡§æ‡§∞ ‡§Æ‡•á‡§Ç ‡§≤‡•â‡§ó‡§Ü‡§â‡§ü ‡§¨‡§ü‡§®
    with st.sidebar:
        st.write(f"User: Admin")
        if st.button("Log Out"):
            st.session_state['logged_in'] = False
            st.rerun()
    
    st.title("üìä GeM Contract Manager & Ledger")

    # --- TABS: ‡§®‡§Ø‡§æ ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä vs ‡§™‡•Å‡§∞‡§æ‡§®‡§æ ‡§á‡§§‡§ø‡§π‡§æ‡§∏ ---
    tab1, tab2 = st.tabs(["‚ûï New Entry / Calculator", "üìú View History"])

    # ==========================
    # TAB 1: ‡§ï‡•à‡§≤‡§ï‡•Å‡§≤‡•á‡§ü‡§∞ ‡§î‡§∞ ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä
    # ==========================
    with tab1:
        st.markdown("### Calculate Profit & Save Entry")
        
        # --- ‡§´‡•â‡§∞‡•ç‡§Æ ---
        col1, col2, col3 = st.columns(3)
        with col1:
            contract_no = st.text_input("Contract No", "GEMC-511687769269311")
            entry_date = st.date_input("Date", date.today())
        with col2:
            agency_name = st.text_input("Agency Name", "Ordnance Clothing Factory")
            invoice_no = st.text_input("Invoice No", "31")
        with col3:
            item_name = st.text_input("Item Particular", "Good Year 215/75 R15 TL")
            qty = st.text_input("Quantity", "08 Nos")

        st.markdown("---")
        st.subheader("Financials (‚Çπ)")
        
        c1, c2, c3, c4 = st.columns(4)
        purchase_val = c1.number_input("Purchase Value", value=40000)
        transport = c2.number_input("Transport Charge", value=1644)
        sale_val = c3.number_input("Sale Amount", value=46680)
        
        # GST Inputs
        c5, c6 = st.columns(2)
        purchase_gst = c5.number_input("Purchase GST (Input)", value=8750)
        sale_gst = c6.number_input("Sale GST (Output)", value=10211)

        # --- ‡§ó‡§£‡§®‡§æ (Calculations) ---
        total_investment = purchase_val + transport
        net_profit = sale_val - total_investment
        net_gst = sale_gst - purchase_gst
        gst_status = "Payable" if net_gst > 0 else "Credit"

        # --- ‡§∞‡§ø‡§ú‡§≤‡•ç‡§ü ‡§¶‡§ø‡§ñ‡§æ‡§®‡§æ ---
        st.success(f"üí∞ Net Profit: ‚Çπ {net_profit:,} | üè¶ GST {gst_status}: ‚Çπ {abs(net_gst):,}")

        # --- ‡§ö‡§æ‡§∞‡•ç‡§ü‡•ç‡§∏ ---
        ch1, ch2 = st.columns(2)
        with ch1:
            fig1, ax1 = plt.subplots(figsize=(4, 3))
            ax1.bar(['Purchase', 'Trans', 'Profit'], [purchase_val, transport, net_profit], color=['#ff9999', '#66b3ff', '#99ff99'])
            ax1.set_title("Cost Breakdown")
            st.pyplot(fig1)
        
        # --- ‡§∏‡•á‡§µ ‡§î‡§∞ PDF ‡§¨‡§ü‡§® ---
        col_btn1, col_btn2 = st.columns(2)
        
        # 1. Save Button
        if col_btn1.button("üíæ Save Entry to History"):
            new_data = {
                "Date": [entry_date],
                "Contract": [contract_no],
                "Agency": [agency_name],
                "Total_Invest": [total_investment],
                "Sale_Amt": [sale_val],
                "Profit": [net_profit],
                "GST_Net": [net_gst]
            }
            df_new = pd.DataFrame(new_data)
            
            # CSV ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡•ú‡•á‡§Ç
            file_path = 'ledger_db.csv'
            header_needed = not os.path.isfile(file_path)
            df_new.to_csv(file_path, mode='a', header=header_needed, index=False)
            st.toast("‚úÖ Entry Saved Successfully!", icon="üéâ")

        # 2. PDF Button
        def create_pdf():
            pdf = FPDF()
            pdf.add_page()
            pdf.set_font("Arial", 'B', 16)
            pdf.cell(200, 10, txt="GeM Contract Report", ln=True, align='C')
            pdf.set_font("Arial", size=12)
            pdf.ln(10)
            pdf.cell(0, 10, f"Contract: {contract_no}", ln=True)
            pdf.cell(0, 10, f"Agency: {agency_name}", ln=True)
            pdf.ln(5)
            pdf.cell(0, 10, f"Total Investment: {total_investment} | Sale: {sale_val}", ln=True)
            pdf.set_font("Arial", 'B', 12)
            pdf.cell(0, 10, f"NET PROFIT: {net_profit}", ln=True)
            return pdf.output(dest='S').encode('latin-1')

        pdf_data = create_pdf()
        col_btn2.download_button("üìÑ Download PDF", data=pdf_data, file_name=f"Report_{contract_no}.pdf", mime="application/pdf")

    # ==========================
    # TAB 2: ‡§á‡§§‡§ø‡§π‡§æ‡§∏ (HISTORY)
    # ==========================
    with tab2:
        st.header("üìú Transaction History")
        
        file_path = 'ledger_db.csv'
        if os.path.exists(file_path):
            # ‡§°‡•á‡§ü‡§æ ‡§™‡•ù‡•á‡§Ç
            df = pd.read_csv(file_path)
            
            # ‡§∏‡§¨‡§∏‡•á ‡§ä‡§™‡§∞ ‡§ï‡•Å‡§õ ‡§¨‡•ú‡•á ‡§Ü‡§Ç‡§ï‡•ú‡•á ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç
            total_profit_all = df['Profit'].sum() if 'Profit' in df.columns else 0
            st.metric("üèÜ Total Profit (Till Date)", f"‚Çπ {total_profit_all:,}")
            
            # ‡§™‡•Ç‡§∞‡•Ä ‡§ü‡•á‡§¨‡§≤ ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç
            st.dataframe(df, use_container_width=True)
            
            # CSV ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§¨‡§ü‡§®
            csv_data = df.to_csv(index=False).encode('utf-8')
            st.download_button("üì• Download Full Excel/CSV", data=csv_data, file_name="Full_Ledger.csv", mime="text/csv")
            
        else:
            st.info("‚ö†Ô∏è No records found yet. Please save data first.")

# ==========================================
# üöÄ 3. ‡§ê‡§™ ‡§ö‡§≤‡§æ‡§®‡§æ
# ==========================================
if not st.session_state['logged_in']:
    check_login()
else:
    main_app()